# 🔧 去除课程引用中的 Markdown 格式符号

## 问题描述

在报告的"提升建议"部分引用课程内容时，单词和句子会带有 markdown 格式符号：
- 单词前后有 `**` 符号：如 `**family**`、`**brother**`
- 句子前面有 `-` 符号：如 `- This is my family`

这些符号在报告中显示时不美观，需要去除。

## 问题原因

在 `curriculumService.ts` 的 `formatForImprovementSuggestions()` 函数中：
1. 使用了 `**` 来格式化标题和单词（markdown 加粗语法）
2. 使用了 `-` 来标记列表项
3. 这些格式被注入到 AI prompt 中，AI 学习了这种格式并在生成建议时保留了这些符号

## 修复方案

### 修改 1: 去除核心词汇和句式中的 markdown 符号

**文件**: `server/services/curriculumService.ts`

#### 修改前
```typescript
// 核心词汇
sections.push(`**核心词汇**: ${vocabList}...`);

// 核心句式
sections.push('**核心句式**:');
context.sentences.slice(0, 8).forEach(sentence => {
  sections.push(`  - ${sentence}`);  // ❌ 使用了 - 符号
});

// 拼读内容
sections.push(`**拼读内容**: ${phonics}`);
```

#### 修改后
```typescript
// 核心词汇
sections.push(`【核心词汇】: ${vocabList}...`);  // ✅ 使用中文方括号

// 核心句式
sections.push('【核心句式】:');
context.sentences.slice(0, 8).forEach((sentence, index) => {
  sections.push(`  ${index + 1}. ${sentence}`);  // ✅ 使用数字编号
});

// 拼读内容
sections.push(`【拼读内容】: ${phonics}`);  // ✅ 使用中文方括号
```

### 修改 2: 更新示例格式

**文件**: `server/services/curriculumService.ts`

#### 修改前
```typescript
sections.push('**示例格式**：');
sections.push('"建议Leo进行单词跟读练习。从本单元的核心词汇中，可以选择以下单词进行重点练习：\\n');
sections.push('- **family** /ˈfæməli/ - 注意\'a\'的发音\\n');  // ❌
sections.push('- **brother** /ˈbrʌðər/ - 注意\'th\'的发音\\n');  // ❌
```

#### 修改后
```typescript
sections.push('【示例格式】：');
sections.push('"建议Leo进行单词跟读练习。从本单元的核心词汇中，可以选择以下单词进行重点练习：');
sections.push('');
sections.push('1) family /ˈfæməli/ - 注意 a 的发音');  // ✅ 纯文本
sections.push('2) brother /ˈbrʌðər/ - 注意 th 的发音');  // ✅ 纯文本
sections.push('');
sections.push('练习建议：每天跟读5-10遍，注意模仿正确发音。"');
```

#### 添加明确的格式指示
```typescript
sections.push('🚨 重要：在生成建议时，请直接引用单词和句子，不要使用任何 markdown 格式符号（如 ** 或 - 等），保持纯文本格式。');
```

### 修改 3: 增强 AI Prompt 中的格式要求

**文件**: `server/services/videoAnalysisService.ts`

在全局要求中添加格式说明：

```typescript
🚨 **关于"提升建议"(improvementAreas.suggestions)的全局要求**：
1. 每个维度（pronunciation、grammar、intonation）都需要生成2个建议
2. 总共6个建议中，引用的课程单词和句子**必须全部不同**，不能有任何重复
3. 建议的分配策略：...
4. 如果课程内容不足以支撑6个不重复的建议...
5. **🚨 格式要求**：在建议内容中引用单词和句子时，请使用纯文本格式，不要使用任何 markdown 符号（如 **、-、* 等）。单词和句子应该直接写出，可以使用数字编号（如 1)、2)）或简单的换行分隔。
```

## 修复效果

### 修复前
```
建议Leo进行单词应用练习。从本单元的核心词汇中，可以选择以下单词进行重点练习：
- **family** /ˈfæməli/ - 注意 a 的发音
- **brother** /ˈbrʌðər/ - 注意 th 的发音
```

### 修复后
```
建议Leo进行单词应用练习。从本单元的核心词汇中，可以选择以下单词进行重点练习：

1) family /ˈfæməli/ - 注意 a 的发音
2) brother /ˈbrʌðər/ - 注意 th 的发音

练习建议：每天跟读5-10遍，注意模仿正确发音。
```

## 验证方法

### 步骤 1: 生成新报告
1. 打开应用
2. 填写学生信息（确保填写了 level 和 unit）
3. 上传两个视频
4. 点击"生成报告"

### 步骤 2: 检查报告内容
在生成的报告中，找到"提升建议"部分，检查：

✅ **正确显示**（修复后）:
```
建议练习以下单词：

1) family /ˈfæməli/ - 注意 a 的发音
2) brother /ˈbrʌðər/ - 注意 th 的发音

建议练习以下句式：

1) This is my family. - 基础陈述句
2) I have a brother. - 所有格表达
```

❌ **错误显示**（如果出现）:
```
- **family** /ˈfæməli/
- **brother** /ˈbrʌðər/
- This is my family.
```

### 步骤 3: 检查后端日志
如果 AI 仍然生成了 markdown 符号，可以在日志中看到课程引用的格式。

## 技术细节

### 修改文件
1. `server/services/curriculumService.ts` - 格式化课程内容的函数
2. `server/services/videoAnalysisService.ts` - AI prompt 的全局要求

### 修改策略
1. **符号替换**: `**` → 中文方括号【】，`-` → 数字编号
2. **示例更新**: 提供正确的纯文本示例格式
3. **明确指示**: 在 prompt 中明确要求不使用 markdown 符号

### 为什么使用中文方括号【】？
- 视觉上更清晰醒目
- 不会被误认为是需要保留的格式符号
- 仅用于 prompt 中的标识，不会出现在最终报告中

## 注意事项

1. **仅影响新报告**: 修改只对新生成的报告有效，已保存的旧报告不会更新
2. **AI 可能仍有偏好**: GLM-4 可能仍然倾向于使用 markdown 格式，需要通过明确的指示来纠正
3. **示例很重要**: AI 会学习示例格式，确保示例中没有 markdown 符号
4. **代码已自动重载**: 使用 `tsx watch` 模式，修改后自动生效

## 相关改进

这次修复同时优化了：
- 课程内容在 prompt 中的展示格式
- 使用数字编号代替项目符号，更清晰
- 在多个地方强调了纯文本格式的要求

---

📅 修复日期: 2025-11-18  
📝 文档版本: 1.0  
✅ 状态: 已完成

