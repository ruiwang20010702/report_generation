# 项目说明文档（全生命周期管理）

## 项目规划
- 项目名称：51Talk 英语学习分析系统
- 项目目标：支持英语学习视频的自动转写与AI对比分析，生成结构化学习报告。
- 技术栈：前端 React + Vite + TypeScript；后端 Express + TypeScript；数据库 PostgreSQL；边缘函数（Vercel Functions）。
- 主要模块：
  - 后端服务与路由（analysis、auth）
  - 边缘函数（api/analysis、api/auth）
  - 视频与语音分析服务（阿里云/GLM，Whisper/AssemblyAI 兼容）
  - 前端页面与认证流程
  - 数据库（users、otps、reports）
  - 部署与环境变量
- 范围约束：严格按本说明文档执行，不扩展超出规划的功能；如需扩展，先更新此文档规划并评估可行性。
- 里程碑与时间节点：
  - 2025-11-11：代码结构梳理完成（后端、前端、边缘函数、数据库）
  - 2025-11-11：环境变量、脚本与部署配置梳理完成
  - 2025-11-12：问答与风险排查（按需）

## 实施方案
- 方法论：采用顺序化思考（MCPsequential thinking），将需求拆解为可执行的任务清单，逐项完成并回填进度。
- 执行流程：
  1. 梳理后端入口与路由，识别中间件、端点与服务依赖
  2. 梳理视频分析与认证服务，确认模型与秘钥来源
  3. 梳理数据库与 SQL 表结构，确认字段与索引
  4. 梳理前端路由与认证流程，确认守卫与上下文逻辑
  5. 梳理 api 边缘函数，确认与后端服务的协作关系
  6. 梳理环境变量、脚本与部署（Vercel）配置
- 质量保障：每一步完成后进行静态检查、自检与文档更新；遇到问题优先查阅上下文与官方文档。

## 环境变量清单（汇总）
- 通用/运行：
  - `NODE_ENV`（vercel.json 默认 production）
  - `PORT`、`FRONTEND_URL`、`USE_MOCK_ANALYSIS`
  - 代理：`HTTPS_PROXY`、`HTTP_PROXY`
- AI 模型：
  - 主用：`GLM_API_KEY`（智谱 GLM，服务端强制优先）
  - 可选：`OPENAI_API_KEY`、`QWEN_API_KEY`、`DEEPSEEK_API_KEY`、`ASSEMBLYAI_API_KEY`
- 语音服务（阿里云）：
  - `ALIYUN_ACCESS_KEY_ID`、`ALIYUN_ACCESS_KEY_SECRET`
  - `ALIYUN_TINGWU_APP_KEY` 或 `ALIYUN_NLS_APP_KEY`
  - `ALIYUN_PROXY_URL`、`ALIYUN_ALLOW_PROXY`、`ALIYUN_REJECT_UNAUTHORIZED`
  - `TINGWU_LANGUAGE`
- 数据库（PostgreSQL）：
  - `DB_HOST`、`DB_PORT`、`DB_NAME`、`DB_USER`、`DB_PASSWORD`
  - `DB_POOL_MAX`、`DB_POOL_IDLE_TIMEOUT`、`DB_POOL_CONNECTION_TIMEOUT`
  - `DB_SSL`、`DB_SSL_REJECT_UNAUTHORIZED`
- 认证/安全：
  - `JWT_SECRET`
- 邮件服务：
  - `SMTP_HOST`、`SMTP_PORT`、`SMTP_USER`、`SMTP_PASS`、`SMTP_FROM`
- 其他：
  - `VIDEO_STORAGE_PATH`、`MAX_VIDEO_SIZE`
  - 文档中涉及（可选）：`SUPABASE_URL`、`SUPABASE_ANON_KEY`、`UPSTASH_REDIS_REST_URL`、`UPSTASH_REDIS_REST_TOKEN`、`SENTRY_DSN`、`QSTASH_TOKEN`、`ALERT_EMAIL`

## 部署与脚本
- 开发：
  - `npm run dev:all`（同时启动前后端）
  - `npm run dev:frontend`（Vite 前端：默认 5173/8080）
  - `npm run dev:backend`（Express 后端：默认 3001）
- 构建与预览：
  - `npm run build`（后端：`tsc -p tsconfig.server.json`；前端：`vite build`）
  - `npm run preview`
 - 生产启动（后端）：
  - `npm run start`（运行 `node build/server/index.js`，监听 `process.env.PORT`）
- 环境与数据库：
  - `npm run setup:env`（交互式生成 .env）
  - `npm run check:env`（必要项检查）
  - `npm run setup:db`（创建表） / `npm run test:db`（连接测试）
- Vercel 配置：`vercel.json`
  - `functions: api/**/*.ts`（边缘函数，`maxDuration: 60`）
  - `rewrites`：`/((?!api).*) -> /index.html`
  - 统一 CORS 头；`env.NODE_ENV=production`

## 代码结构速览
- 后端入口：`server/index.ts`（Express 中间件、路由、错误处理、端口与启动日志）
- 后端路由：
  - `server/routes/analysis.ts`：转写调试、视频分析、健康检查、配额统计
  - `server/routes/auth.ts`：发送/验证 OTP、密码登录、设置密码、用户信息、登出
- 服务逻辑：
  - `videoAnalysisService.ts`：核心分析（强制 GLM，支持 Mock，代理），转写/分析与对比
  - `authService.ts`：OTP 生成与验证、密码登录、设置密码、JWT 签发
  - 语音转写：`tingwuTranscriptionService.ts`、`aliyunTranscriptionService.ts`、`assemblyAIService.ts`、`whisperService.ts`
  - 邮件服务：`emailService.ts`
- 边缘函数（api/）：
  - `analysis/analyze.ts`、`analysis/health.ts`
  - `auth/send-otp.ts`、`auth/verify-otp.ts`、`auth/logout.ts`、`auth/me.ts`
- 数据库与 SQL：`database/*.sql` 与 `database/README.md`
- 前端：
  - 入口与路由：`src/App.tsx`、`src/components/ProtectedRoute.tsx`
  - 认证上下文：`src/contexts/AuthContext.tsx`
  - 登录页面：`src/pages/Login.tsx`
  - API 封装：`src/services/api.ts`、`src/services/auth.ts`
  - 首页与报告：`src/pages/Index.tsx`、`src/components/ReportDisplay.tsx`

## 进度记录（时间节点）
- 2025-11-11 10:00：创建说明文档，建立全生命周期管理
- 2025-11-11 10:10：梳理后端入口与服务结构（完成）
- 2025-11-11 10:20：梳理后端路由与服务逻辑（完成）
- 2025-11-11 10:30：梳理数据库配置与 SQL 表结构（完成）
- 2025-11-11 10:40：梳理前端应用结构与页面路由（完成）
- 2025-11-11 10:50：梳理前端认证流程与 API 封装（完成）
- 2025-11-11 11:00：梳理 api 边缘函数端点（完成）
- 2025-11-11 11:15：梳理环境变量、脚本与部署配置（完成）
 - 2025-11-11 11:25：确认认证前后端文件（AuthContext、Login、ProtectedRoute）并标注路径修正（完成）
 - 2025-11-11 11:30：确认视频分析路由与转录服务配额统计（quota/getStats）实现与返回结构（完成）
 - 2025-11-11 11:35：输出结构化项目概览，进入问答阶段（完成）
 - 2025-11-11 11:50：执行历史清理（方案B）：使用 git-filter-repo 移除 `.env.production` 与 `.env.vercel`，自动移除远程后已重新添加 `origin` 并强制推送 `feat/english-defaults-transcription` 分支（完成）。备注：提交历史已变更（SHA 更新），协作开发需基于新历史拉取或重置本地分支。
 - 2025-11-11 12:00：合并 `feat/english-defaults-transcription` 至主干分支并推送远程（完成）。说明：仓库主干为 `master`（非 `main`），本次合并使用 `--allow-unrelated-histories` 以融合清理后的分支历史。
 - 2025-11-11 12:10：增加服务端构建与启动脚本（`tsconfig.server.json`、`npm run start`），完成 Zeabur 部署前置准备（完成）。
 - 2025-11-11 17:48：修复部署失败（TS7016：缺少 `uuid` 类型声明）——新增 `@types/uuid`、补充 `server/types/uuid.d.ts` 并将 `.d.ts` 纳入 `tsconfig.server.json`；已重新触发 Zeabur 部署并跟踪构建状态（进行中）。
- 2025-11-11 18:20：环境变量配置准备（进行中）——梳理后端所需键名并生成 Zeabur 批量粘贴模板；待用户将本地 `.env` 的真实密钥粘贴到 Zeabur 变量原始编辑器后继续验证与记录。
 - 2025-11-11 18:45：采纳方案B（单服务部署）并完成落地（已完成）——在后端启用静态托管 `dist` 与 SPA 回退路由；前端默认 API 基址改为 `window.location.origin`；更新文档与环境变量样例以反映单服务模式。
 - 2025-11-11 19:10：Zeabur CLI 交互式部署成功（已完成）——新增 `.zeaburignore` 限制上传范围以避免 S3 上传超时；项目与服务上下文已设置；部署后域名需在仪表盘确认绑定。环境变量审核建议：
   - 必设：`JWT_SECRET`（当前为空将回退到默认值，存在安全风险）
   - 单服务：不设置 `VITE_API_URL`（或移除反引号，避免值为带符号的字符串）；默认同域即可
   - 数据库：`DB_SSL=true`；`DB_SSL_REJECT_UNAUTHORIZED=false/true` 可按证书实际情况调整（Aliyun RDS 公网常用 `false`）；建议运行数据库连接测试脚本验证
   - 邮件：`SMTP_HOST=smtp.qq.com`、`SMTP_PORT=587`、`SMTP_USER/SMTP_PASS/SMTP_FROM` 均已配置，保持即可
 - 其他：`USE_MOCK_ANALYSIS=false`、`TINGWU_LANGUAGE=en`、`ALIYUN_ALLOW_PROXY=false`、`ALIYUN_REJECT_UNAUTHORIZED=true` 建议保持
  - 清理：移除未使用的 `PASSWORD` 变量；密钥泄露需在提供方控制台立即轮换
 - 2025-11-12 09:54：健康检查访问空白（已定位并修复方案制定）——在浏览器直接访问 `https://51talkreportgeneration.zeabur.app/api/analysis/health` 显示空白，排查结果：当前服务类型为 `PREBUILT_V2`（静态站点），`/api/*` 未由 Node 服务处理而被重写到 `index.html`（`vercel.json` 的 rewrites 生效）。验证信息：`curl -I` 显示 `Content-Type: text/html`。修复方案：
   1) 切换为 Node 运行时或容器部署：Build `npm run build`，Start `npm start`，端口 `3001`；
   2) 已在仓库根新增 `Dockerfile`，强制以容器运行 Node 服务（同时托管前端 `dist`），在 Zeabur 仪表盘将该服务切换为 Dockerfile 部署后重新发布；
   3) 若保留前后端分离：前端服务需设置 `VITE_API_URL=https://<后端域名>`；
   4) 验收：`curl https://<服务域名>/api/analysis/health` 返回 `application/json`，示例：`{"status":"ok","useMock":false,...}`；
   5) 记录：切换完成后更新本文"Zeabur 部署（规划与现状）"与"环境变量模板"以反映最终架构。
| - 2025-11-12 14:00：Zeabur 部署配置优化（已完成）——修正了部署文档和配置文件中的问题：
   1) 移除 zeabur.yaml 中硬编码的 PORT 环境变量和端口配置（Zeabur 会自动注入）
   2) 修正 server/index.ts 中的数据库连接检查逻辑，支持 DATABASE_URL
   3) 更新 ZEABUR_DEPLOYMENT.md 和 QUICKSTART_ZEABUR.md，明确说明 PORT 和 DATABASE_URL 由 Zeabur 自动管理
   4) 优化 Dockerfile 注释，说明端口配置的文档性质
   5) 改进数据库连接失败的故障排除步骤
| - 2025-11-12 15:30：Zeabur PostgreSQL 数据库部署文档准备完成（已完成）——创建了完整的数据库部署指南：
   1) 创建 `ZEABUR_DATABASE_SETUP.md` - 详细部署指南（6个章节，包含故障排查和最佳实践）
   2) 创建 `ZEABUR_DATABASE_QUICKSTART.md` - 5分钟快速操作清单（4个步骤）
   3) 创建 `docs/deployment/ZEABUR_DATABASE_CHECKLIST.md` - 可打印的检查清单（5个阶段，含故障排查）
   4) 更新 `database/init.sql` - 合并的初始化 SQL 脚本（包含 users、otps、reports 三张表及索引）
   5) 更新说明文档，添加"数据库部署"章节，记录部署方式、步骤和验证方法
   待用户执行：在 Zeabur 控制台添加 PostgreSQL 服务 → 执行 init.sql → 重启应用 → 验证连接

## Zeabur 部署（规划与现状）
- 架构现状：已采用方案B（单服务一体化）——后端服务同时托管前端 `dist`，非 `/api` 路由回退到 `index.html`。使用 Dockerfile 进行容器化部署。
- 如需分离部署：
  - 后端（Node 服务）：从 GitHub 仓库部署，`Build Command: npm run build:server`，`Start Command: npm run start`。
  - 前端（静态站点）：从 GitHub 仓库部署，`Build Command: npm run build`，`Publish Directory: dist`。
- 环境变量（通过 Zeabur 仪表盘设置，不提交到仓库）：
  - 通用：`USE_MOCK_ANALYSIS`；分离部署时可设置 `FRONTEND_URL`；单服务模式可忽略。
  - **注意**：`PORT` 和 `DATABASE_URL` 由 Zeabur 平台自动注入，**不需要手动设置**。
  - 模型：`GLM_API_KEY`（或 `DEEPSEEK_API_KEY`/`QWEN_API_KEY`/`OPENAI_API_KEY`）。
  - 阿里云：`ALIYUN_ACCESS_KEY_ID`、`ALIYUN_ACCESS_KEY_SECRET`、`ALIYUN_TINGWU_APP_KEY`（可选）。
  - 数据库（使用 Zeabur PostgreSQL 时）：Zeabur 会自动注入 `DATABASE_URL`；如使用外部数据库，需手动设置 `DB_HOST`、`DB_PORT`、`DB_NAME`、`DB_USER`、`DB_PASSWORD`、`DB_SSL`。
  - 认证与邮件：`JWT_SECRET`、`SMTP_HOST`、`SMTP_PORT`、`SMTP_USER`、`SMTP_PASS`、`SMTP_FROM`。
- 前端变量：
  - 单服务模式：不设置 `VITE_API_URL`（前端默认同域）。
  - 分离部署：`VITE_API_URL` 指向后端服务公开域名，例如 `https://backend-xxxxx.zeabur.app`。
- 安全：
  - 不在仓库提交 `.env`；若密钥曾泄露，需在提供方控制台立即轮换密钥。
- 参考文档：
  - Zeabur Node.js 部署指南 [https://zeabur.com/docs/en-US/guides/nodejs]
  - 环境变量设置指南 [https://zeabur.com/docs/en-US/deploy/variables]

## 环境变量模板（Zeabur）
用于在 Zeabur 仪表盘批量创建环境变量，复制下方内容并按需填写占位符：

```env
# ==============================
# Zeabur 环境变量清单模板（批量粘贴可用）
# ==============================

# 基础运行
NODE_ENV=production
USE_MOCK_ANALYSIS=false
# PORT 由 Zeabur 自动注入，不需要手动设置
# FRONTEND_URL=https://your-frontend-domain.example.com

# 代理（如需）
# HTTPS_PROXY=http://user:pass@host:port
# HTTP_PROXY=http://user:pass@host:port

# AI 模型（主用 GLM，其他可选）
GLM_API_KEY=
# OPENAI_API_KEY=
# QWEN_API_KEY=
# DEEPSEEK_API_KEY=
# ASSEMBLYAI_API_KEY=

# 阿里云语音（通义听悟/NLS）
ALIYUN_ACCESS_KEY_ID=
ALIYUN_ACCESS_KEY_SECRET=
# ALIYUN_TINGWU_APP_KEY=
# ALIYUN_NLS_APP_KEY=
TINGWU_LANGUAGE=en
# ALIYUN_PROXY_URL=http://user:pass@host:port
ALIYUN_ALLOW_PROXY=false
ALIYUN_REJECT_UNAUTHORIZED=true

# 数据库（PostgreSQL）
# DATABASE_URL 由 Zeabur 自动注入（使用 Zeabur PostgreSQL 时）
# 如使用外部数据库，则需手动设置以下变量：
# DB_HOST=postgres.example.internal
# DB_PORT=5432
# DB_NAME=app_db
# DB_USER=app_user
# DB_PASSWORD=strong-password-here
# DB_POOL_MAX=20
# DB_POOL_IDLE_TIMEOUT=30000
# DB_POOL_CONNECTION_TIMEOUT=10000
# DB_SSL=true
# DB_SSL_REJECT_UNAUTHORIZED=true

# 认证与安全
JWT_SECRET=

# 邮件服务（可选）
# SMTP_HOST=smtp.example.com
# SMTP_PORT=587
# SMTP_USER=your-smtp-user
# SMTP_PASS=your-smtp-pass
# SMTP_FROM=noreply@example.com

# 前端（如使用 Vite 前端）
# VITE_API_URL=https://your-backend-service.zeabur.app

# 观测与队列（可选）
# SENTRY_DSN=
# UPSTASH_REDIS_REST_URL=
# UPSTASH_REDIS_REST_TOKEN=
# SUPABASE_URL=
# SUPABASE_ANON_KEY=
# QSTASH_TOKEN=
# ALERT_EMAIL=
# LOG_SERVICE_URL=

# 其他开关（仅测试场景）
# USE_QWEN=false
# ==============================
```

设置建议：
- 必填：`GLM_API_KEY`、`ALIYUN_ACCESS_KEY_ID`、`ALIYUN_ACCESS_KEY_SECRET`、`JWT_SECRET`。
- 建议：生产环境关闭 `USE_MOCK_ANALYSIS`；数据库/邮件按需启用。
- 安全：真实密钥仅在 Zeabur 仪表盘设置，不提交到 Git。

## 环境配置步骤（Zeabur）
为保证秘钥不外泄，采用平台“原始编辑器”批量粘贴方式：
- 1) 打开 Zeabur 仪表盘 → 选择后端服务 → “环境变量”页签 → 点击“编辑原始环境变量”。
- 2) 在本地打开你的 `.env`，复制以下行（保持 Key=Value 原样，不要暴露在聊天中）：
  - `GLM_API_KEY=...`
  - `ALIYUN_ACCESS_KEY_ID=...`
  - `ALIYUN_ACCESS_KEY_SECRET=...`
  - （如有）`ALIYUN_TINGWU_APP_KEY=...`
  - `JWT_SECRET=...`
  - （可选）`OPENAI_API_KEY=...`、`SMTP_*`、`DB_*`、`FRONTEND_URL`、`VITE_API_URL`
- 3) 将上述行粘贴到“原始编辑器”，并补充建议项：`USE_MOCK_ANALYSIS=false`、`TINGWU_LANGUAGE=en`、`ALIYUN_ALLOW_PROXY=false`、`ALIYUN_REJECT_UNAUTHORIZED=true`。
- 4) 保存后平台会自动重启服务。

### 验证方法
- 运行时日志：使用 Zeabur 部署日志（Runtime）确认“Server is running on port …”“通义听悟服务已初始化”“GLM-4-Plus”等字样。
- 健康检查：访问 `GET /api/analysis/health`，`useMock` 应为 `false`。
- 听悟可用性：`POST /api/analysis/transcribe-test` 传入可访问的视频 URL，返回语言、时长与片段统计。


## 风险与约束
- 绝不允许项目延期：如需调整计划，先更新本说明文档的时间节点并记录原因。
- 绝不允许超出计划：变更范围需先在“项目规划”模块评估并更新。
- 绝不允许出错：每次变更需自检（编译、接口测试、日志检查），问题按照“技术支撑规范”优先查阅上下文与官方文档处理。

## 数据库部署（Zeabur PostgreSQL）
- 部署时间：2025-11-12 15:30（文档准备完成，待用户执行）
- 部署方式：Zeabur Marketplace → PostgreSQL Prebuilt Service
- 环境变量：`DATABASE_URL` 由 Zeabur 自动注入（无需手动配置）
- 初始化脚本：`database/init.sql`（包含 users、otps、reports 三张表，已更新）
- 部署文档已创建：
  1. `ZEABUR_DATABASE_SETUP.md` - 完整部署指南（含故障排查和最佳实践）
  2. `ZEABUR_DATABASE_QUICKSTART.md` - 5分钟快速部署清单
  3. `docs/deployment/ZEABUR_DATABASE_CHECKLIST.md` - 可打印的检查清单
  4. `database/init.sql` - 合并的初始化 SQL 脚本（可一次性执行）
- 部署步骤（5 分钟）：
  1. 在 Zeabur 项目中添加 PostgreSQL 服务（2 分钟）
  2. 进入 PostgreSQL Web Console，执行 `database/init.sql`（2 分钟）
  3. 重启应用服务（Redeploy）（1 分钟）
  4. 验证数据库连接（查看日志或测试 API）
- 验证方法：
  - 应用日志显示 "✅ 数据库连接成功"
  - 健康检查接口返回 `"database": "connected"`
  - 测试用户注册流程（发送验证码 → 验证 OTP）
- 故障排查：
  - DATABASE_URL 未注入 → 等待 2-3 分钟后重启应用
  - 连接超时 → 检查服务状态，等待初始化完成
  - 表不存在 → 重新执行 init.sql
  - SSL 错误 → 代码已处理（rejectUnauthorized: false）

## 后续动作（问答阶段）
- 准备答疑：可基于以上结构随时提出深入问题（认证安全、模型切换、API 限流、部署策略等），我将结合代码与官方文档进行解答。