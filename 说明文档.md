# 项目说明文档（全生命周期管理）

## 项目规划
- 项目名称：51Talk 英语学习分析系统
- 项目目标：支持英语学习视频的自动转写与AI对比分析，生成结构化学习报告。
- 技术栈：前端 React + Vite + TypeScript；后端 Express + TypeScript；数据库 PostgreSQL；边缘函数（Vercel Functions）。
- 主要模块：
  - 后端服务与路由（analysis、auth）
  - 边缘函数（api/analysis、api/auth）
  - 视频与语音分析服务（阿里云/GLM，Whisper/AssemblyAI 兼容）
  - 前端页面与认证流程
  - 数据库（users、otps、reports）
  - 部署与环境变量
- 范围约束：严格按本说明文档执行，不扩展超出规划的功能；如需扩展，先更新此文档规划并评估可行性。
- 里程碑与时间节点：
  - 2025-11-11：代码结构梳理完成（后端、前端、边缘函数、数据库）
  - 2025-11-11：环境变量、脚本与部署配置梳理完成
  - 2025-11-12：问答与风险排查（按需）

## 实施方案
- 方法论：采用顺序化思考（MCPsequential thinking），将需求拆解为可执行的任务清单，逐项完成并回填进度。
- 执行流程：
  1. 梳理后端入口与路由，识别中间件、端点与服务依赖
  2. 梳理视频分析与认证服务，确认模型与秘钥来源
  3. 梳理数据库与 SQL 表结构，确认字段与索引
  4. 梳理前端路由与认证流程，确认守卫与上下文逻辑
  5. 梳理 api 边缘函数，确认与后端服务的协作关系
  6. 梳理环境变量、脚本与部署（Vercel）配置
- 质量保障：每一步完成后进行静态检查、自检与文档更新；遇到问题优先查阅上下文与官方文档。

## 环境变量清单（汇总）
- 通用/运行：
  - `NODE_ENV`（vercel.json 默认 production）
  - `PORT`、`FRONTEND_URL`、`USE_MOCK_ANALYSIS`
  - 代理：`HTTPS_PROXY`、`HTTP_PROXY`
- AI 模型：
  - 主用：`GLM_API_KEY`（智谱 GLM，服务端强制优先）
  - 可选：`OPENAI_API_KEY`、`QWEN_API_KEY`、`DEEPSEEK_API_KEY`、`ASSEMBLYAI_API_KEY`
- 语音服务（阿里云）：
  - `ALIYUN_ACCESS_KEY_ID`、`ALIYUN_ACCESS_KEY_SECRET`
  - `ALIYUN_TINGWU_APP_KEY` 或 `ALIYUN_NLS_APP_KEY`
  - `ALIYUN_PROXY_URL`、`ALIYUN_ALLOW_PROXY`、`ALIYUN_REJECT_UNAUTHORIZED`
  - `TINGWU_LANGUAGE`
- 数据库（PostgreSQL）：
  - `DB_HOST`、`DB_PORT`、`DB_NAME`、`DB_USER`、`DB_PASSWORD`
  - `DB_POOL_MAX`、`DB_POOL_IDLE_TIMEOUT`、`DB_POOL_CONNECTION_TIMEOUT`
  - `DB_SSL`、`DB_SSL_REJECT_UNAUTHORIZED`
- 认证/安全：
  - `JWT_SECRET`
- 邮件服务：
  - `SMTP_HOST`、`SMTP_PORT`、`SMTP_USER`、`SMTP_PASS`、`SMTP_FROM`
- 其他：
  - `VIDEO_STORAGE_PATH`、`MAX_VIDEO_SIZE`
  - 文档中涉及（可选）：`SUPABASE_URL`、`SUPABASE_ANON_KEY`、`UPSTASH_REDIS_REST_URL`、`UPSTASH_REDIS_REST_TOKEN`、`SENTRY_DSN`、`QSTASH_TOKEN`、`ALERT_EMAIL`

## 部署与脚本
- 开发：
  - `npm run dev:all`（同时启动前后端）
  - `npm run dev:frontend`（Vite 前端：默认 5173/8080）
  - `npm run dev:backend`（Express 后端：默认 3001）
- 构建与预览：
  - `npm run build`（tsc + vite build）
  - `npm run preview`
- 环境与数据库：
  - `npm run setup:env`（交互式生成 .env）
  - `npm run check:env`（必要项检查）
  - `npm run setup:db`（创建表） / `npm run test:db`（连接测试）
- Vercel 配置：`vercel.json`
  - `functions: api/**/*.ts`（边缘函数，`maxDuration: 60`）
  - `rewrites`：`/((?!api).*) -> /index.html`
  - 统一 CORS 头；`env.NODE_ENV=production`

## 代码结构速览
- 后端入口：`server/index.ts`（Express 中间件、路由、错误处理、端口与启动日志）
- 后端路由：
  - `server/routes/analysis.ts`：转写调试、视频分析、健康检查、配额统计
  - `server/routes/auth.ts`：发送/验证 OTP、密码登录、设置密码、用户信息、登出
- 服务逻辑：
  - `videoAnalysisService.ts`：核心分析（强制 GLM，支持 Mock，代理），转写/分析与对比
  - `authService.ts`：OTP 生成与验证、密码登录、设置密码、JWT 签发
  - 语音转写：`tingwuTranscriptionService.ts`、`aliyunTranscriptionService.ts`、`assemblyAIService.ts`、`whisperService.ts`
  - 邮件服务：`emailService.ts`
- 边缘函数（api/）：
  - `analysis/analyze.ts`、`analysis/health.ts`
  - `auth/send-otp.ts`、`auth/verify-otp.ts`、`auth/logout.ts`、`auth/me.ts`
- 数据库与 SQL：`database/*.sql` 与 `database/README.md`
- 前端：
  - 入口与路由：`src/App.tsx`、`src/components/ProtectedRoute.tsx`
  - 认证上下文：`src/contexts/AuthContext.tsx`
  - 登录页面：`src/pages/Login.tsx`
  - API 封装：`src/services/api.ts`、`src/services/auth.ts`
  - 首页与报告：`src/pages/Index.tsx`、`src/components/ReportDisplay.tsx`

## 进度记录（时间节点）
- 2025-11-11 10:00：创建说明文档，建立全生命周期管理
- 2025-11-11 10:10：梳理后端入口与服务结构（完成）
- 2025-11-11 10:20：梳理后端路由与服务逻辑（完成）
- 2025-11-11 10:30：梳理数据库配置与 SQL 表结构（完成）
- 2025-11-11 10:40：梳理前端应用结构与页面路由（完成）
- 2025-11-11 10:50：梳理前端认证流程与 API 封装（完成）
- 2025-11-11 11:00：梳理 api 边缘函数端点（完成）
- 2025-11-11 11:15：梳理环境变量、脚本与部署配置（完成）
 - 2025-11-11 11:25：确认认证前后端文件（AuthContext、Login、ProtectedRoute）并标注路径修正（完成）
 - 2025-11-11 11:30：确认视频分析路由与转录服务配额统计（quota/getStats）实现与返回结构（完成）
 - 2025-11-11 11:35：输出结构化项目概览，进入问答阶段（完成）
 - 2025-11-11 11:50：执行历史清理（方案B）：使用 git-filter-repo 移除 `.env.production` 与 `.env.vercel`，自动移除远程后已重新添加 `origin` 并强制推送 `feat/english-defaults-transcription` 分支（完成）。备注：提交历史已变更（SHA 更新），协作开发需基于新历史拉取或重置本地分支。

## 风险与约束
- 绝不允许项目延期：如需调整计划，先更新本说明文档的时间节点并记录原因。
- 绝不允许超出计划：变更范围需先在“项目规划”模块评估并更新。
- 绝不允许出错：每次变更需自检（编译、接口测试、日志检查），问题按照“技术支撑规范”优先查阅上下文与官方文档处理。

## 后续动作（问答阶段）
- 准备答疑：可基于以上结构随时提出深入问题（认证安全、模型切换、API 限流、部署策略等），我将结合代码与官方文档进行解答。