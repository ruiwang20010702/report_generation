# 📊 并发用户数分析与提升空间

## 📋 当前配置

### 每份报告的资源消耗
- **听悟转录服务**：2次（video1 + video2）
- **GLM分析服务**：3次（video1分析 + video2分析 + 对比分析）
- **分析平均耗时**：1.5-8分钟（正常1.5-3分钟，慢速3.5-8分钟）

### 💰 成本说明

#### 1. API成本（听悟+GLM）
- **每份报告成本**：约 **¥1**（人民币）
- **成本构成**：
  - 听悟转录：约 ¥0.1-0.2（根据视频时长）
  - GLM分析：约 ¥0.8-0.9（3次GLM调用）
- **当前限流下的API成本**：
  - 每小时最多：30次 × ¥1 = **¥30/小时**
  - 每天最多：720次 × ¥1 = **¥720/天**（理论最大值）

#### 2. 服务器成本（Zeabur）

**基础套餐费用：**
- **免费试用**：$0/月（1 vCPU, 2GB内存，包含$5免费额度）
- **开发者套餐**：$5/月（2 vCPU, 4GB内存，包含$5免费额度）
- **团队套餐**：$80/月（4 vCPU, 8GB内存）

**资源用量费用（按实际使用计费）：**
- **CPU**：免费（$0/vCPU/分钟）
- **内存**：$0.00025/GB/分钟 ≈ **$10/GB/月**
- **出口流量**：**$0.1/GB**
- **持久存储**：**$0.2/GB/月**

**实际成本预估（基于开发者套餐 $5/月）：**

| 使用场景 | 用户/天 | 应用服务 | 数据库 | 流量 | 总计（美元） | 总计（人民币） |
|---------|---------|---------|--------|------|------------|--------------|
| **测试阶段** | <10 | $5-10 | $2 | $2 | **$9-14** | **¥65-101** |
| **轻度使用** | 10-30 | $10 | $5 | $2 | **$17** | **¥122** |
| **中度使用** | 50-80 | $15-25 | $8 | $5 | **$28-38** | **¥200-274** |
| **警戒线** | >100 | $30+ | $10+ | $10+ | **$50+** | **¥360+** |

**说明：**
- 以上是**服务器成本**（Zeabur），不包括API成本
- 实际成本会根据CPU、内存、流量使用量动态变化
- 建议在Zeabur控制台设置预算警报（如$30/月）
- 如果月成本超过$40，考虑迁移到阿里云（更经济）

#### 3. 总成本（API + 服务器）

**轻度使用（10-30用户/天）：**
- API成本：约 ¥360/月（假设每天120次分析）
- 服务器成本：约 ¥122/月
- **总计：约 ¥482/月**

**中度使用（50-80用户/天，有限流）：**
- API成本：约 ¥1440-2160/月（当前限流下理论最大值：¥2160/天，实际使用约¥50-70/天）
- 服务器成本：约 ¥200-274/月
- **总计：约 ¥1640-2434/月**（实际约¥1500-2000/月）

### 当前限流策略
- **分析接口限流**：每10分钟最多 **15次** 分析请求（已大幅放宽，原5次）
- **全局限流**：每15分钟最多 **200个** 请求
- **认证接口限流**：每15分钟最多 **5次** 登录尝试

---

## 👥 并发用户数计算

### 理论最大并发用户数

#### 基于限流窗口（10分钟）
```
每10分钟最多15次分析 = 每10分钟最多15个用户
每小时最多 = 15 × 6 = 90个用户
每天最多 = 90 × 24 = 2160个用户（理论值）
```

#### 基于实际处理时间（考虑分析耗时）

**场景1：快速分析（平均2分钟）**
- 每10分钟窗口：15个新请求
- 同时进行：15个（新） + 2个（仍在处理中）≈ **17个并发用户**

**场景2：正常分析（平均3分钟）**
- 每10分钟窗口：15个新请求
- 同时进行：15个（新） + 3个（仍在处理中）≈ **18个并发用户**

**场景3：慢速分析（平均5分钟）**
- 每10分钟窗口：15个新请求
- 同时进行：15个（新） + 5个（仍在处理中）≈ **20个并发用户**

### 实际并发用户数（保守估计）

考虑到：
- 用户不是同时开始分析
- 网络延迟和重试
- 部分用户可能失败

**实际并发用户数：约 15-24 个**

---

## 📈 提升空间分析

### 1. 进一步放宽限流 ⭐⭐⭐⭐⭐

#### 方案A：适度放宽（推荐）
```typescript
// 当前：10分钟/5次
// 建议：10分钟/10次
max: 10
```

**影响：**
- 并发用户数：5-8 → **10-16**
- 每小时：30 → **60个用户**
- 每天：720 → **1440个用户**
- API成本：¥720/天 → **¥1440/天**（理论最大值，每份报告约¥1）

#### 方案B：大幅放宽 ✅ **已实施**
```typescript
// 已实施：10分钟/15次
max: 15
```

**影响：**
- 并发用户数：5-8 → **15-24** ✅
- 每小时：30 → **90个用户** ✅
- 每天：720 → **2160个用户** ✅
- API成本：¥720/天 → **¥2160/天**（理论最大值，每份报告约¥1）⚠️

#### 方案C：取消分析限流（仅保留全局限流）
```typescript
// 移除分析接口专用限流
// 仅保留：15分钟/200请求的全局限流
```

**影响：**
- 并发用户数：取决于全局限流和服务器资源
- 风险：成本不可控，可能被滥用

### 2. 优化限流策略 ⭐⭐⭐⭐

#### 当前问题
- 限流基于 **IP地址**，同一网络下的多个用户会共享限制
- 无法区分真实用户和恶意请求

#### 优化方案：基于用户ID限流
```typescript
// 需要用户登录后，基于 userId 限流
const analysisLimiter = rateLimit({
  windowMs: 10 * 60 * 1000,
  max: 5,
  keyGenerator: (req) => {
    // 优先使用 userId，fallback 到 IP
    return req.user?.id || req.ip;
  }
});
```

**好处：**
- 每个真实用户独立限流
- 同一网络下的多个用户不受影响
- 更公平的资源分配

**影响：**
- 并发用户数：**提升 2-3倍**（取决于用户分布）
- 需要实现用户认证系统

### 3. 增加服务器实例 ⭐⭐⭐

#### Zeabur 自动扩容
- 当前配置：最多 **3个实例**
- 每个实例独立限流，总并发 = 单实例并发 × 实例数

**影响：**
- 并发用户数：5-8 → **15-24**（3个实例）
- 成本：服务器成本 × 3（但API成本不变）

### 4. 优化代码减少API调用 ⭐⭐

#### 当前流程
```
视频1: 转录 → GLM分析
视频2: 转录 → GLM分析
最后: GLM对比分析
```

#### 优化方案（需要业务调整）
- 合并分析：将video1和video2的分析合并为一次调用
- 缓存转录结果：相同视频只转录一次

**限制：**
- 用户明确要求：2次听悟 + 3次GLM（业务需求）
- 优化空间有限

### 5. 使用更快的模型 ⭐⭐⭐

#### 当前：GLM-4（较慢但准确）
#### 优化：混合使用 GLM-4 + GLM-4-Turbo

**影响：**
- 分析时间：3分钟 → **1.5-2分钟**
- 并发用户数：5-8 → **8-12**（处理更快，释放资源）
- 成本：可能略有增加

---

## 🎯 推荐提升方案

### 短期（立即实施）

#### 1. 适度放宽限流
```typescript
// 10分钟/5次 → 10分钟/10次
max: 10
```
**预期提升：** 并发用户数 **2倍**（5-8 → 10-16）

#### 2. 监控和调整
- 部署后监控实际使用量
- 根据成本和资源使用情况动态调整

### 中期（1-2周）

#### 1. 实现基于用户ID的限流
- 需要用户认证系统
- 更公平的资源分配

#### 2. 优化分析流程
- 使用更快的模型（GLM-4-Turbo）
- 减少不必要的API调用

### 长期（1个月+）

#### 1. 多实例部署
- Zeabur自动扩容到3个实例
- 总并发提升3倍

#### 2. 智能限流
- 根据用户等级差异化限流
- VIP用户更高限制

---

## 📊 提升空间总结

| 方案 | 实施难度 | 提升效果 | 成本影响 | 推荐度 |
|------|---------|---------|---------|--------|
| **放宽限流（10次）** | ⭐ 简单 | ⭐⭐⭐⭐ 2倍 | ⭐⭐ 中等 | ⭐⭐⭐⭐⭐ |
| **放宽限流（15次）** | ⭐ 简单 | ⭐⭐⭐⭐⭐ 3倍 | ⭐⭐⭐ 较高 | ⭐⭐⭐⭐ |
| **基于用户ID限流** | ⭐⭐⭐ 中等 | ⭐⭐⭐⭐ 2-3倍 | ⭐ 低 | ⭐⭐⭐⭐ |
| **多实例部署** | ⭐⭐ 简单 | ⭐⭐⭐⭐⭐ 3倍 | ⭐⭐⭐ 较高 | ⭐⭐⭐ |
| **使用更快模型** | ⭐⭐ 中等 | ⭐⭐⭐ 1.5倍 | ⭐⭐ 中等 | ⭐⭐⭐ |

---

## 💡 最终建议

### 立即实施
1. ✅ **放宽限流到 10分钟/10次**（提升2倍，风险可控）
2. ✅ **监控实际使用量和成本**

### 根据实际情况调整
- 如果资源充足且成本可控 → 继续放宽到 **15次**
- 如果用户增长快 → 实施**基于用户ID限流**
- 如果服务器资源充足 → 启用**多实例部署**

### 预期最终并发能力
- **当前（已放宽限流到15次）**：15-24个并发用户 ✅
- **中期（+用户ID限流）**：30-45个并发用户
- **长期（+多实例）**：90-135个并发用户

---

## 📝 注意事项

1. **成本控制**
   
   **API成本（听悟+GLM）：**
   - 当前限流（10分钟/15次）：¥2160/天（理论最大值）⚠️
   - 单次分析成本：约¥1（人民币）
   - 每小时最多：90次 × ¥1 = ¥90
   - 每天最多：2160次 × ¥1 = ¥2160（理论最大值）
   - 建议设置API成本预算警报（如¥5000/月）
   
   **服务器成本（Zeabur）：**
   - 基础套餐：$5/月（开发者套餐）
   - 轻度使用：约 ¥122/月
   - 中度使用：约 ¥200-274/月
   - 建议在Zeabur控制台设置预算警报（$30/月）
   - 如果月成本超过$40（¥288），考虑迁移到阿里云
   
   **总成本监控：**
   - 轻度使用：API ¥360/月 + 服务器 ¥122/月 = **¥482/月**
   - 中度使用：API ¥720/月 + 服务器 ¥200-274/月 = **¥920-994/月**
   - 建议总预算：¥1000-1500/月（包含缓冲）

2. **资源监控**
   - 监控CPU/内存使用率
   - 监控API调用频率
   - 监控错误率

3. **用户体验**
   - 避免过度限流导致用户等待
   - 提供清晰的错误提示
   - 考虑实现排队系统

