# 课程知识库集成方案

## 📋 概述

本方案旨在将Excel课程内容（已转换为JSON）作为外部知识库集成到AI报告生成系统中，**重点应用于"提升建议"部分**。通过引用具体的单元课程内容（词汇、句式、语法等），结合学生的实际问题，让AI给出更具体、更可操作的学习建议。

## 🎯 核心目标

在报告的**"详细建议"**部分，实现：
- ✅ 引用单元中的**具体词汇**（如：family, friend, mother等）
- ✅ 引用单元中的**具体句式**（如：What are you doing? How are you?）
- ✅ 结合学生的**实际问题**（如：发音错误、语法缺失、词汇量不足）
- ✅ 给出**完整的提升路径**（练习什么、如何练习、达到什么目标）

---
## 📂 当前状态

### 已完成的工作
✅ Excel文件已成功转换为10个JSON文件：
- `curriculum-data-LS_K.json` (LS-K级别)
- `curriculum-data-L0___.json` (L0级别)
- `curriculum-data-L1___.json` (L1级别)
- `curriculum-data-L2___.json` (L2级别)
- `curriculum-data-L3___.json` (L3级别)
- `curriculum-data-L4_Eric.json` (L4级别)
- `curriculum-data-L5_Abby.json` (L5级别)
- `curriculum-data-L6_ss____.json` (L6级别)
- `curriculum-data-L7_9_DP.json` (**包含L7、L8、L9三个级别**)
- `curriculum-data-______.json` (统计数据)

**⚠️ 注意**：`curriculum-data-L7_9_DP.json` 文件包含了三个级别的数据：
- Level 7：Unit 1-6（共48课次）
- Level 8：Unit 1-6（共48课次）
- Level 9：Unit 1-6（共48课次）

### 🎯 数据匹配说明

**✅ 用户表单字段 → 课程数据的匹配关系**：

| 表单字段 | 是否需要填写 | JSON数据 | 匹配状态 | 说明 |
|---------|------------|---------|---------|------|
| Level (如 "Level 3") | ✅ **需要填写** | ✅ 有对应文件 | ✅ **完美匹配** | 找到该级别的所有单元 |
| Unit (如 "5") | ✅ **需要填写** | ✅ 有单元数据 | ✅ **完美匹配** | 找到该单元的主题、词汇、句式 |
| Lesson (如 "Lesson 3") | ❌ **不需要填写** | ⚠️ 只有描述性信息 | ✅ **不需要，无影响** | 应用设计本就不需要 |

**关键结论**：
- ✅ **用户表单只需要填写 Level + Unit**
- ✅ **JSON数据提供的正好是 Unit 级别的内容**
- ✅ **数据粒度与应用需求完美匹配，无需额外处理**
- 💡 **Lesson 信息在 JSON 中以描述形式存在（如"强口语 Lesson 1、3、5、7"），但应用不依赖这个信息**

### 数据结构示例

**示例1：Level 1, Unit 1的数据**
```json
{
  "级别": "Level 1",
  "单元数量": "共144课次\n18个unit",
  "Unit": 1,
  "单元主题": "Family and Friends \n家人和朋友",
  "单元知识目标": "词汇：20个\n句子：48个\n拼读：4个\n绘本：2个",
  "课程内容": "强口语 Lesson 1、3、5、7",
  "__EMPTY": "词汇：\nhow、what、fine、he、she、who 等\n\n句式：...",
  "匹配新课标": "人与自我"
}
```

**示例2：Level 7, Unit 1的数据**
```json
{
  "级别": "Level 7",
  "单元数量": "共48课次\n6个unit",
  "Unit": 1,
  "单元主题\n": "Original Fables\n寓言小故事",
  "单元知识目标\n": "词汇：48个\n句子：80个\n语篇：8个",
  "课程内容\n": "阅读赏析",
  "__EMPTY": "Lesson 1 The Boy Who Cried Wolf 狼来了\nLesson 2 The Simple Farmer and HisDonkey 农夫和驴\n...",
  "匹配新课标": "人与自我"
}
```

### 💡 实际查询流程示例

**场景**：用户填写表单
- 学生姓名：张小明
- Level：Level 3
- Unit：5
- 视频1、视频2：（已上传）

**后端查询逻辑**：

```typescript
// 1. 根据Level映射到文件
const levelFileMap = {
  'Level 0': 'curriculum-data-L0___.json',
  'Level 1': 'curriculum-data-L1___.json',
  'Level 2': 'curriculum-data-L2___.json',
  'Level 3': 'curriculum-data-L3___.json',
  // ...
  'Level 7': 'curriculum-data-L7_9_DP.json',
  'Level 8': 'curriculum-data-L7_9_DP.json',
  'Level 9': 'curriculum-data-L7_9_DP.json',
};

// 2. 加载对应的JSON文件
const fileName = levelFileMap['Level 3']; // → 'curriculum-data-L3___.json'
const data = await loadJSON(fileName);

// 3. 筛选出对应的Unit（注意：可能有多行）
const unitData = data.filter(row => row.Unit === 5);

// 4. 提取课程信息
const curriculumContext = {
  level: 'Level 3',
  unit: 5,
  theme: unitData[0].单元主题,          // "单元主题"
  vocabulary: extractVocabulary(unitData), // 从__EMPTY字段解析词汇
  sentences: extractSentences(unitData),   // 从__EMPTY字段解析句式
  goals: unitData[0].单元知识目标        // "词汇：20个\n句子：48个..."
};

// 5. 将课程信息注入到AI Prompt中
const prompt = `
学生姓名：张小明
当前级别：Level 3
当前单元：Unit 5 - ${curriculumContext.theme}

【课程目标】
${curriculumContext.goals}

【核心词汇】
${curriculumContext.vocabulary.join(', ')}

【核心句式】
${curriculumContext.sentences.join('\n')}

【任务】
请根据两段视频的对比，分析学生在以下方面的进步...
（注意：必须引用上述课程内容中的词汇和句式）
`;
```

**✅ 查询结果**：可以获取到该单元的：
- 单元主题（Theme）
- 学习目标（词汇数量、句子数量等）
- 核心词汇列表
- 核心句式列表
- 课程内容描述（包含哪些Lesson）

**⚠️ 无法获取**：
- 某一具体Lesson的详细教案
- Lesson级别的逐课词汇分配
- Lesson级别的练习题

---

## 🎯 实施方案

### 📍 应用位置定位

在现有代码中，AI报告生成位于：
- 文件：`server/services/videoAnalysisService.ts`
- 方法：`compareVideos()` - 第541行起
- Prompt构建：第624-770行附近

**关键发现**：代码中已有完整的prompt结构，包含：
- 学生信息
- 对比分析要求
- 报告格式要求（包括"提升建议"部分）

**集成点**：在生成报告的prompt中，**专门为"提升建议"部分**添加课程知识库的参考信息。

---

### 方案：针对性提升建议法（推荐）

**核心思路**：
1. 在生成报告前，根据学生的Level和Unit查询课程内容
2. 将课程内容**专门用于增强"提升建议"部分**
3. 在prompt中明确指示AI：结合课程内容和学生问题，给出具体可操作的建议

#### 实施步骤：

**步骤1：创建课程服务** (`server/services/curriculumService.ts`)

创建服务类，提供以下核心功能：

```typescript
class CurriculumService {
  // 加载所有JSON文件到内存
  loadCurriculum(): void
  
  // 查询指定单元的课程内容
  getCurriculumContext(level: string, unit: string): CurriculumContext | null
  
  // 专门为提升建议准备的格式化内容
  formatForImprovementSuggestions(context: CurriculumContext): string
}
```

**返回的数据结构**：
```typescript
interface CurriculumContext {
  level: string           // 如：Level 1
  unit: number           // 如：1
  theme: string          // 单元主题：Family and Friends
  vocabulary: string[]   // 核心词汇列表
  sentences: string[]    // 核心句式列表
  phonics: string[]      // 拼读内容（如有）
  goals: string          // 知识目标概述
}
```

---

**步骤2：修改AI分析服务** (`server/services/videoAnalysisService.ts`)

在 `compareVideos` 方法中：

1. **获取课程内容**（第541行附近，在构建prompt前）：
```typescript
// 查询课程知识库
const curriculumContext = curriculumService.getCurriculumContext(
  studentInfo.level,  // 从请求中获取
  studentInfo.unit    // 从请求中获取
);
```

2. **格式化课程内容用于提升建议**：
```typescript
let curriculumReference = '';
if (curriculumContext) {
  curriculumReference = `
## 📚 课程大纲参考（${curriculumContext.theme}）

**本单元核心词汇**：
${curriculumContext.vocabulary.slice(0, 10).join(', ')}

**本单元核心句式**：
${curriculumContext.sentences.slice(0, 5).join('\n')}

**学习目标**：
${curriculumContext.goals}
`;
}
```

3. **注入到Prompt的特定位置**（第624行prompt字符串中）：

在现有prompt中，找到"提升建议"相关的格式说明部分，添加专门的指导：

```typescript
const prompt = `
[现有的系统指令和学生信息...]

${curriculumReference}

## 📋 报告生成要求

[现有的报告格式要求...]

### 🎯 特别要求：提升建议部分

在生成"详细建议"时，请务必：
1. **引用具体课程内容**：直接使用上述课程大纲中的具体词汇和句式作为例子
2. **结合学生实际问题**：分析学生在哪些词汇或句式上表现不足
3. **给出完整提升路径**：
   - 问题诊断：学生在XX方面存在的具体问题
   - 课程关联：该问题涉及本单元的XX词汇/句式
   - 练习建议：具体练习方法（如：重点练习句式"..."，可以通过...方式）
   - 目标设定：练习后应达到的标准

### 建议示例格式：

**词汇提升**
- 问题：学生对家庭成员词汇掌握不牢固，如"grandmother"发音不准确
- 课程目标：本单元要求掌握词汇"family, mother, father, grandmother, grandfather"等
- 提升建议：重点练习这5个核心词汇，特别是"grandmother"的/ˈɡrænmʌðər/发音...
- 练习方法：...

[其他现有的prompt内容...]
`;
```

---

#### 优点：
- **精准**：建议直接对应课程内容，教师和家长能看到明确的学习路径
- **可操作**：具体的词汇和句式让练习更有针对性
- **专业**：体现了对课程大纲的理解，提升报告专业性
- **实施简单**：只改动提升建议部分，风险小

#### 注意事项：
- 课程内容可能较长，建议只提取关键内容（前10个词汇，前5个句式）
- 如果查询不到课程内容，不影响其他部分的报告生成
- 课程内容作为"参考"而非"强制"，AI仍可根据实际情况灵活调整

---

### 方案2：智能检索法（适合长期优化）

**核心思路**：使用向量数据库或语义搜索，根据学生的对话内容智能匹配相关课程知识点。

#### 实施步骤：

1. **向量化课程内容**
   - 使用embedding模型（如OpenAI embedding或智谱AI embedding）
   - 将每个单元的内容转为向量存储
   - 可使用内存向量库（如faiss）或外部向量数据库

2. **语义检索**
   - 提取学生对话中的关键词汇和句式
   - 在向量库中搜索相关课程内容
   - 返回最相关的3-5个单元内容

3. **动态注入Prompt**
   - 将检索到的课程内容动态注入prompt
   - 让AI更智能地关联学生表现和课程目标

#### 优点：
- 智能匹配，不局限于精确的Level/Unit
- 可以发现学生使用了其他单元的知识点
- 分析更全面

#### 缺点：
- 实现复杂度高
- 需要额外的embedding API调用（成本）
- 响应时间稍长

---

## 🚀 实施步骤详解

### 第一步：创建课程服务（30分钟）

**位置**：`server/services/curriculumService.ts`（新建文件）

**功能要求**：
1. 在类初始化时，读取 `docs/` 目录下的所有 `curriculum-data-*.json` 文件
2. 建立 Level 到文件名的映射（如：Level 1 → L1___.json）
3. 提供查询方法 `getCurriculumContext(level, unit)`
4. 从JSON数组中找到匹配的单元，提取：
   - 单元主题（从"单元主题"字段）
   - 核心词汇（从"__EMPTY"字段解析）
   - 核心句式（从"__EMPTY"字段解析）
   - 学习目标（从"单元知识目标"字段）

**关键代码逻辑**：
```typescript
// 伪代码示例
getCurriculumContext(level: string, unit: string) {
  // 1. 映射level到文件名
  const fileName = this.mapLevelToFile(level); // "Level 1" → "L1___.json"
  
  // 2. 加载对应的JSON数组
  let data = this.loadedData[fileName];
  
  // 3. ⚠️ 特殊处理：Level 7/8/9 在同一个文件中，需要额外过滤
  if (['Level 7', 'Level 8', 'Level 9'].includes(level)) {
    // 根据"级别"字段过滤出对应Level的数据
    data = data.filter(row => row.级别 === level || row.级别 === '');
    // 注意：第一行有级别标识，后续行的"级别"字段为空但属于同一级别
  }
  
  // 4. 查找匹配的unit（注意：可能有多行属于同一unit）
  const unitRows = data.filter(row => row.Unit == unit);
  
  // 5. 提取和解析词汇、句式
  const vocabulary = this.extractVocabulary(unitRows);
  const sentences = this.extractSentences(unitRows);
  
  // 6. 返回结构化数据
  return {
    level,
    unit,
    theme: unitRows[0].单元主题 || unitRows[0]['单元主题\n'],
    vocabulary,
    sentences,
    goals: unitRows[0].单元知识目标 || unitRows[0]['单元知识目标\n']
  };
}
```

---

### 第二步：获取学生的Level和Unit（10分钟）

**位置**：`server/services/videoAnalysisService.ts` 的 `compareVideos` 方法

**需要确认的信息**：
- 从哪里获取学生的 `level`？（可能从请求参数、数据库、或视频元数据）
- 从哪里获取学生的 `unit`？（同上）

**如果当前没有这些信息**，需要：
1. 在前端表单中添加 Level 和 Unit 选择框
2. 在 API 请求中传递这些参数
3. 在 `compareVideos` 方法的参数中接收

**示例代码位置**：
```typescript
// 在 compareVideos 方法开始处（第541行附近）
async compareVideos(
  video1Key: string,
  video2Key: string,
  studentInfo: StudentInfo // 确保这里包含 level 和 unit
) {
  // 获取课程上下文
  const { level, unit } = studentInfo;
  const curriculum = curriculumService.getCurriculumContext(level, unit);
  ...
}
```

---

### 第三步：格式化课程内容（15分钟）

**位置**：`server/services/videoAnalysisService.ts` 的 `compareVideos` 方法中

在获取到 `curriculum` 对象后，格式化成适合注入prompt的字符串：

```typescript
let curriculumSection = '';

if (curriculum) {
  // 只取前10个词汇和前5个句式，避免过长
  const vocabList = curriculum.vocabulary.slice(0, 10).join(', ');
  const sentenceList = curriculum.sentences.slice(0, 5).map((s, i) => `   ${i+1}. ${s}`).join('\n');
  
  curriculumSection = `

## 📚 课程大纲参考

**当前单元**：${curriculum.theme}
**学习目标**：${curriculum.goals}

**本单元核心词汇**：
${vocabList}

**本单元核心句式**：
${sentenceList}

---
`;
}
```

---

### 第四步：注入Prompt（20分钟）

**位置**：`server/services/videoAnalysisService.ts` 第624-770行附近的 prompt 字符串

**修改策略**：
在现有 prompt 中找到合适的位置（建议在"学生信息"之后，"报告要求"之前）插入：

1. **插入课程内容**：
```typescript
const prompt = `
你是一位专业的英语教学分析师...

## 学生信息
姓名：${studentName}
年龄：${age}
级别：${level}

${curriculumSection}  // ← 在这里插入课程内容

## 📋 报告生成要求
...
`;
```

2. **在"提升建议"部分的要求中，添加专门指导**：

找到 prompt 中关于"提升建议"的格式说明（可能在第700行附近），在该部分添加：

```typescript
### 四、提升建议（improvement_suggestions）

**格式要求**：
{
  detailed_suggestions: [
    {
      category: "词汇/句式/语法/流利度/发音/互动",
      current_issue: "具体问题描述",
      curriculum_reference: "该问题对应的课程内容（词汇或句式）",  // ← 新增
      suggestion: "具体改进建议",
      practice_method: "练习方法",  // ← 新增
      target: "目标标准"  // ← 新增
    }
  ]
}

**⚠️ 特别要求（提升建议部分）**：

在生成详细建议时，必须：
1. 引用上述"课程大纲参考"中的具体词汇和句式
2. 将学生的问题与课程目标进行对比
3. 在 curriculum_reference 字段中明确列出相关的课程词汇或句式
4. 在 practice_method 字段中给出具体可操作的练习方法
5. 在 target 字段中设定阶段性目标（1周、2周、单元结束时）

示例：
{
  category: "词汇",
  current_issue: "学生对家庭成员词汇掌握不足，主要使用 mom/dad 等非正式词汇",
  curriculum_reference: "本单元要求掌握：family, mother, father, grandmother, grandfather, sister, brother",
  suggestion: "重点练习标准家庭成员词汇，替换日常对话中的非正式用词",
  practice_method: "每天10分钟，结合家庭照片用完整句式介绍：This is my mother/father. 制作单词卡片进行复习。",
  target: "1周内流利说出8个家庭成员词汇；2周内能用完整句式介绍家庭成员"
}
```

---

### 第五步：测试验证（20分钟）

**测试案例**：
1. 准备一个 Level 1, Unit 1 的学生视频对比请求
2. 确认能成功查询到课程内容（Family and Friends主题）
3. 查看生成的报告中"提升建议"部分是否包含：
   - ✅ 具体的词汇列表（如：mother, father, grandmother...）
   - ✅ 具体的句式示例（如：This is my...）
   - ✅ 与学生问题的关联
   - ✅ 具体的练习方法

**调试检查点**：
- [ ] CurriculumService 能正确加载所有JSON文件
- [ ] Level 映射正确（Level 1 → L1___.json）
- [ ] 能找到对应的 Unit 数据
- [ ] 词汇和句式解析正确（从 __EMPTY 字段）
- [ ] Prompt 中包含了课程内容
- [ ] AI生成的建议引用了具体的课程内容

---

### 第六步：优化调整（持续）

根据实际效果，可能需要调整：

1. **词汇提取逻辑优化**
   - JSON中的词汇格式可能不统一（如："how、what、fine"）
   - 需要智能解析逗号、顿号、换行分隔的词汇

2. **Prompt指令精炼**
   - 如果AI没有很好地遵循指令，需要加强prompt的措辞
   - 可以提供更多的示例

3. **课程内容筛选**
   - 如果10个词汇太多，减少到5-8个
   - 优先选择"基础词汇"而非"扩展词汇"

4. **错误处理**
   - 如果课程内容未找到，给出友好提示而非报错
   - 记录日志，便于排查问题

---

## 📝 关键实现点

### 1. Level映射
JSON文件名与表单中的level可能不完全对应，需要建立映射：
```
level: "Level 0" → 文件: curriculum-data-L0___.json
level: "Level 1" → 文件: curriculum-data-L1___.json
level: "Level 2" → 文件: curriculum-data-L2___.json
...
level: "Level 6" → 文件: curriculum-data-L6_ss____.json
level: "Level 7" → 文件: curriculum-data-L7_9_DP.json (从文件中筛选 级别="Level 7")
level: "Level 8" → 文件: curriculum-data-L7_9_DP.json (从文件中筛选 级别="Level 8")
level: "Level 9" → 文件: curriculum-data-L7_9_DP.json (从文件中筛选 级别="Level 9")
level: "LS-K" → 文件: curriculum-data-LS_K.json
```

**⚠️ 特别注意**：Level 7、8、9都在同一个JSON文件中，查询时需要：
1. 先加载 `curriculum-data-L7_9_DP.json` 文件
2. 根据 `"级别"` 字段过滤出对应的Level数据
3. 再根据 Unit 查询具体单元

### 2. Unit查询
- 每个JSON是数组结构，需要遍历找到匹配的Unit
- 注意有些行的Unit为空（是补充说明行）
- 需要合并连续的相关行（如"强口语"和"强拼读"都属于同一单元）

### 3. 数据清洗
JSON中有很多 `__EMPTY`、`__EMPTY_1` 等字段：
- `__EMPTY` 通常包含详细的词汇和句式
- 其他字段可能是空的或包含补充信息
- 需要智能提取有价值的内容

### 4. Prompt长度控制
- 课程内容可能很长，需要提取关键信息
- 建议只注入：单元主题、核心词汇（5-10个）、核心句式（3-5个）
- 避免超过AI的token限制

---

## 🧪 测试建议

### 测试用例1：精确匹配
- Level: "Level 1"
- Unit: "1"
- 期望：返回 "Family and Friends" 单元的内容

### 测试用例2：边界情况
- Level: "Level 1"
- Unit: "18" （最后一个单元）
- 期望：正确返回最后单元内容

### 测试用例3：错误处理
- Level: "Level 1"
- Unit: "999" （不存在）
- 期望：返回空或默认信息，不影响报告生成

---

## 📊 预期效果对比

### ❌ 集成前的提升建议（泛泛而谈）

```
**词汇建议**
建议学生多积累词汇，扩大词汇量。可以通过阅读英文绘本、观看英语动画片等方式学习新单词。

**句式建议**
建议练习更多的句型，提高表达能力。可以跟着老师多做造句练习。
```

**问题**：
- ❌ 没有具体的词汇或句式
- ❌ 不知道该学哪些内容
- ❌ 建议太宽泛，难以执行
- ❌ 家长不知道如何辅导

---

### ✅ 集成后的提升建议（具体可操作）

```
**词汇提升建议**

【问题诊断】
通过对比分析发现，学生在本单元（Unit 1: Family and Friends）的家庭成员词汇掌握上存在不足。
虽然能说出 "mom", "dad"，但对于标准词汇 "mother", "father" 使用较少，
且对 "grandmother", "grandfather", "aunt", "uncle" 等扩展词汇尚未掌握。

【课程目标】
根据 Level 1 Unit 1 的课程大纲，本单元要求学生掌握以下核心词汇：
- 基础词汇（必须掌握）：family, mother, father, sister, brother
- 扩展词汇（建议掌握）：grandmother, grandfather, aunt, uncle, cousin
- 相关词汇：friend, how, what, fine, he, she, who

【具体建议】
1. **重点词汇练习**（每天10分钟）
   - 本周重点：mother, father, grandmother, grandfather
   - 练习方式：
     * 看着家庭照片，用完整句子介绍："This is my mother/father/grandmother."
     * 跟读标准发音，特别注意 "grandmother" 的 /ˈɡrænmʌðər/ 发音
     * 制作单词卡片，每天复习

2. **句式应用练习**
   本单元核心句式：
   - "Who is he/she?" → "He/She is my..."
   - "How are you?" → "I'm fine, thank you."
   - "What's your name?" → "My name is..."
   
   练习方法：每天用这3个句式各造3个句子，结合家庭成员词汇

3. **阶段目标**
   - 1周内：能流利说出8个家庭成员词汇（mother, father, sister, brother, grandmother, grandfather, aunt, uncle）
   - 2周内：能用 "This is my..." 句式介绍家庭成员，发音准确
   - 单元结束时：能达到课程要求的20个核心词汇掌握

---

**句式提升建议**

【问题诊断】
学生目前多使用简单的单词回应，完整句式使用频率低。
例如问 "How are you?"，学生回答 "Good"，而非标准句式 "I'm fine/good, thank you."

【课程目标】
本单元要求掌握48个句子结构，核心包括：
- 问候句式："How are you?" / "I'm fine, thank you."
- 介绍句式："This is my..." / "He/She is..."
- 询问句式："Who is he/she?" / "What's your name?"

【具体建议】
1. **句式固定搭配练习**
   - 看到 "How are you?" → 必须回答完整句 "I'm fine/good, thank you. And you?"
   - 介绍他人时 → 必须用 "This is my..." 或 "He/She is my..."
   - 不要只说单词，养成说完整句的习惯

2. **日常对话应用**
   每天课前课后，用本单元句式进行3-5轮对话练习：
   - 老师/家长："How are you today?"
   - 学生："I'm fine, thank you. And you?"
   - 老师/家长："Who is she?"（指向照片）
   - 学生："She is my mother."

3. **目标设定**
   - 1周内：熟练使用3个核心问候句式
   - 2周内：能用完整句式介绍5个家庭成员
   - 单元结束：达到课程要求的句式应用标准
```

**优势**：
- ✅ 明确指出学生的具体问题（如：用"mom"而非"mother"）
- ✅ 列出课程要求的具体词汇和句式
- ✅ 提供可执行的练习方法（每天10分钟，具体练什么）
- ✅ 设定阶段性目标，方便追踪进度
- ✅ 家长和老师都能理解和辅导

---

## 🔧 技术细节

### 文件结构
```
server/
  services/
    curriculumService.ts    # 新建：课程知识库服务
    videoAnalysisService.ts # 修改：注入课程上下文
docs/
  curriculum-data-*.json    # 已有：课程数据
```

### 核心方法签名
```typescript
// CurriculumService
class CurriculumService {
  loadCurriculum(): void
  getCurriculumContext(level: string, unit: string): CurriculumContext | null
}

// 返回数据结构
interface CurriculumContext {
  level: string
  unit: number
  theme: string          // 单元主题
  vocabulary: string[]   // 核心词汇
  sentences: string[]    // 核心句式
  goals: string          // 知识目标
  standards: string      // 新课标对应
}
```

### 错误处理
- 如果找不到对应课程内容，不影响报告生成
- 记录日志便于调试
- 提供默认的空上下文

---

## 📌 注意事项

1. **编码问题**：JSON文件包含中文，确保以UTF-8读取
2. **内存占用**：所有JSON加载到内存约1-2MB，可接受
3. **数据更新**：如果Excel更新，需要重新运行转换脚本
4. **Level命名**：注意Level的不同写法（"Level 1" vs "L1" vs "LS-K"）
5. **Token成本**：每次添加课程上下文会增加约200-500 tokens输入

---

## 🎬 快速开始检查清单

### 开始前准备
- [ ] 确认所有JSON文件在 `docs/` 目录下
- [ ] 确认前端表单或API中有 Level 和 Unit 字段
- [ ] 确认 TypeScript 和 Node.js 环境正常

### 实施检查清单
- [ ] **步骤1**：创建 `server/services/curriculumService.ts` 文件
- [ ] **步骤2**：实现 Level 到文件名的映射逻辑
- [ ] **步骤3**：实现从JSON解析词汇和句式的逻辑
- [ ] **步骤4**：测试独立运行 curriculumService（console.log输出）
- [ ] **步骤5**：在 videoAnalysisService 中导入 curriculumService
- [ ] **步骤6**：在 compareVideos 方法中获取学生的 level 和 unit
- [ ] **步骤7**：调用 getCurriculumContext 并格式化
- [ ] **步骤8**：将课程内容注入到 prompt 中
- [ ] **步骤9**：在 prompt 中添加"提升建议"的特别要求
- [ ] **步骤10**：测试完整流程，检查生成的报告

### 验收标准
- [ ] 报告的"提升建议"部分包含具体的课程词汇（至少5个）
- [ ] 报告的"提升建议"部分包含具体的课程句式（至少3个）
- [ ] 建议中有 curriculum_reference 字段
- [ ] 建议中有 practice_method 字段
- [ ] 建议中有 target 字段（阶段性目标）
- [ ] 建议能结合学生的实际问题
- [ ] 如果课程内容未找到，不影响报告其他部分

---

## ⚠️ 常见问题

### Q1: Level 名称不统一怎么办？
**A**: 在 curriculumService 中建立完整的映射表：
```typescript
const levelMap = {
  'Level 0': 'L0___',
  'L0': 'L0___',
  'level 0': 'L0___',
  
  'Level 1': 'L1___',
  'L1': 'L1___',
  'level 1': 'L1___',
  
  // ... L2-L6 类似
  
  'Level 7': 'L7_9_DP',  // ⚠️ 注意：L7/8/9共用一个文件
  'L7': 'L7_9_DP',
  'level 7': 'L7_9_DP',
  
  'Level 8': 'L7_9_DP',
  'L8': 'L7_9_DP',
  'level 8': 'L7_9_DP',
  
  'Level 9': 'L7_9_DP',
  'L9': 'L7_9_DP',
  'level 9': 'L7_9_DP',
  
  'LS-K': 'LS_K',
  'LSK': 'LS_K',
};
```

### Q2: JSON中的词汇格式不统一（逗号、顿号、换行）怎么处理？
**A**: 使用正则表达式统一分割：
```typescript
const vocabulary = text.split(/[,、，\n]+/).map(v => v.trim()).filter(v => v);
```

### Q3: 有些单元的数据缺失怎么办？
**A**: 做好错误处理，返回 null 或默认值，不影响报告生成：
```typescript
if (!curriculum) {
  console.log(`课程内容未找到：Level ${level} Unit ${unit}`);
  // 继续生成报告，只是没有课程参考部分
}
```

### Q4: 怎么知道 prompt 是否真的包含了课程内容？
**A**: 在调用 AI 前，先 console.log 整个 prompt，检查内容：
```typescript
console.log('=== Final Prompt ===');
console.log(prompt);
console.log('===================');
```

### Q5: AI 没有按照要求引用课程内容怎么办？
**A**: 加强 prompt 的指令，使用更强的措辞（如："必须"、"务必"），并提供更详细的示例。

### Q6: 如何正确查询Level 7/8/9的数据？
**A**: 由于L7、L8、L9在同一个JSON文件中，查询时需要特殊处理：

```typescript
// 错误做法 ❌
const unitRows = data.filter(row => row.Unit == unit);

// 正确做法 ✅
// 第一步：先根据级别过滤（只适用于L7/8/9）
let levelData = data;
if (['Level 7', 'Level 8', 'Level 9'].includes(level)) {
  // 找到该级别的起始位置
  const startIndex = data.findIndex(row => row.级别 === level);
  // 找到下一个级别的起始位置（或文件末尾）
  const nextLevelIndex = data.findIndex((row, idx) => 
    idx > startIndex && row.级别 && row.级别 !== level
  );
  
  levelData = nextLevelIndex > -1 
    ? data.slice(startIndex, nextLevelIndex)
    : data.slice(startIndex);
}

// 第二步：再根据Unit过滤
const unitRows = levelData.filter(row => row.Unit == unit);
```

**关键点**：
- L7的数据从第3行开始（`"级别": "Level 7"`）
- L8的数据从第69行开始（`"级别": "Level 8"`）
- L9的数据从第135行开始（`"级别": "Level 9"`）
- 每个级别后续的行中，`"级别"` 字段为空字符串，表示属于上一个级别

---

## 💡 后续优化方向

### 1. 前端展示优化
在生成的报告中，将课程相关内容高亮显示：
- 词汇部分标注"课程要求✓"
- 使用不同颜色区分课程内容和额外建议

### 2. 学习进度追踪
根据多次报告，统计学生在该单元的：
- 词汇掌握率（已掌握/应掌握）
- 句式应用率
- 单元完成度

### 3. 跨单元分析
如果学生使用了其他单元的词汇或句式，标注为"超前学习"或"复习巩固"

### 4. 智能推荐
根据学生的弱项，推荐：
- 相关单元的补充学习
- 难度适中的练习资源

---

## 📞 技术支持

建议先从最简单的 **Level 1, Unit 1** 开始测试，因为：
- 数据结构相对完整
- 词汇和句式清晰
- 容易验证效果

如果遇到问题，可以分步调试：
1. 先确保 JSON 能正确加载
2. 再确保能找到对应的 Unit
3. 最后确保 prompt 注入成功

---

**文档版本**：v2.0（聚焦提升建议）  
**创建时间**：2025-11-18  
**更新时间**：2025-11-18  
**状态**：待实施  
**预计实施时间**：1.5 - 2小时

