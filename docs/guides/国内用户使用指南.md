# 🇨🇳 国内用户使用指南

## 🎯 问题说明

如果您在**中国大陆**使用本系统，可能会遇到以下问题：

- ❌ AssemblyAI 无法访问（需要VPN）
- ⚠️ OpenAI Whisper 速度慢（需要代理）
- 💰 转录成本较高（无免费额度）

## ✨ 解决方案：阿里云语音服务

我们已经为国内用户集成了**阿里云智能语音服务**：

### 核心优势

| 特性 | 说明 |
|------|------|
| 🚫 **无需VPN** | 国内服务器，直接访问 |
| 💰 **免费额度** | 每月2小时（120分钟） |
| ⚡ **速度快** | 低延迟，稳定性高 |
| 🎯 **功能完善** | 支持英语识别和说话人分离 |
| 🔄 **智能降级** | 额度用完自动切换到备用服务 |

## 🚀 5分钟快速配置

### 步骤 1: 注册阿里云账号

1. 访问 [阿里云官网](https://www.aliyun.com/)
2. 点击"免费注册"
3. 完成手机号验证和实名认证

### 步骤 2: 开通语音服务

1. 进入 [智能语音交互控制台](https://nls-portal.console.aliyun.com/)
2. 点击"立即开通"
3. 选择"录音文件识别服务"
4. 确认开通（**免费**）

### 步骤 3: 获取密钥

#### 3.1 创建 AppKey

```
控制台 → 项目管理 → 创建项目
  ├─ 项目名称:  
  └─ 复制 AppKey (格式：nls-xxxxx)
```

#### 3.2 创建 AccessKey

```
右上角头像 → AccessKey 管理 → 创建 AccessKey
  ├─ 复制 AccessKey ID
  └─ 复制 AccessKey Secret（⚠️ 只显示一次）
```

### 步骤 4: 配置环境变量

编辑项目根目录的 `.env` 文件：

```bash
# 阿里云语音服务配置（国内首选，用于语音转文字）
ALIYUN_ACCESS_KEY_ID=你的AccessKey_ID
ALIYUN_ACCESS_KEY_SECRET=你的AccessKey_Secret
ALIYUN_NLS_APP_KEY=你的AppKey

# ============ AI 大模型配置（用于智能分析）============

# 方案1：通义千问（推荐，国内用户）✨
QWEN_API_KEY=你的通义千问API_Key
USE_QWEN=true

# 方案2：OpenAI（国际用户，或作为备用）
OPENAI_API_KEY=你的OpenAI_Key

# 可选：如果访问 OpenAI 需要代理
HTTPS_PROXY=http://127.0.0.1:7890
```

> 💡 **重要说明**：
> - **语音转文字**：推荐使用阿里云（国内快速且免费）
> - **智能分析**：推荐使用通义千问（完全兼容 OpenAI，国内快速）
> - 如果两个都配置了，系统会优先使用阿里云服务

### 步骤 5: 配置通义千问（智能分析服务）

**为什么需要通义千问？**

阿里云语音服务只负责"语音转文字"，而通义千问负责"智能分析"（分析学生表现、生成报告等）。

#### 5.1 开通通义千问服务

1. 访问 [通义千问控制台](https://dashscope.console.aliyun.com/)
2. 点击"立即开通"（**免费**，无需付费）
3. 同意服务协议

#### 5.2 获取 API Key

```
控制台右上角 → API-KEY 管理 → 创建新的 API-KEY
  └─ 复制 API Key（格式：sk-xxxxx）
```

#### 5.3 添加到 .env 文件

```bash
# 通义千问配置（用于智能分析）
QWEN_API_KEY=sk-你的通义千问API_Key
USE_QWEN=true
```

#### 5.4 测试通义千问配置

```bash
node test-qwen.js
```

**预期输出：**
```
✅ 通义千问 API 连接成功！
⏱️  响应时间: 1.2 秒
💬 模型: qwen-plus
```

### 步骤 6: 启动服务

```bash
# 安装依赖（首次运行）
npm install

# 启动服务
npm run dev:all
```

## ✅ 验证配置

### 方法 1: 运行完整测试

```bash
# 测试阿里云语音服务
node test-aliyun.js

# 测试通义千问服务
node test-qwen.js
```

**预期输出（阿里云）：**
```
✅ 阿里云: 已配置（国内优先）
   - 免费额度: 120分钟/月
   - 速度: ⚡ 快（国内服务器）
   - 网络: ✅ 无需VPN
```

**预期输出（通义千问）：**
```
✅ 通义千问 API 连接成功！
⏱️  响应时间: 1.2 秒
📝 模型: qwen-plus
💬 回复内容: 我是一位专业的英语教学专家...
```

### 方法 2: 查看启动日志

启动服务后，您应该看到：

```
✅ Default mode: REAL - using 通义千问 (Qwen) API
🇨🇳 国内服务，无需 VPN，响应更快！
✅ 阿里云语音服务已初始化
💰 当前剩余免费额度: 120 分钟
```

### 方法 3: 测试实际转录

1. 访问 http://localhost:8080
2. 点击"快速测试"
3. 关闭"使用模拟数据"
4. 点击"开始分析"

**查看后端日志：**
```
🇨🇳 [Video 1] 使用阿里云语音服务（国内免费服务）
✅ 阿里云转录任务已提交
⏳ 转录进行中... (35%)
✅ 转录任务完成！
```

## 📊 完整的国内优化方案

### 🎯 双重服务架构

本系统使用两个独立的 AI 服务：

| 服务类型 | 功能 | 国内推荐方案 | 国际方案 |
|---------|------|------------|---------|
| **语音转文字** | 将视频音频转为文字 | 阿里云智能语音 🇨🇳 | AssemblyAI / Whisper |
| **智能分析** | 分析学生表现，生成报告 | 通义千问 🇨🇳 | OpenAI GPT-4 |

### 🔄 语音转文字降级策略

系统会按以下顺序自动选择服务：

```
┌─────────────────────────────────────┐
│ 1️⃣  阿里云（国内优先）              │
│    - 前120分钟免费                  │
│    - 无需VPN                        │
│    - 速度快                         │
└─────────────────────────────────────┘
            ↓ 不可用/超额
┌─────────────────────────────────────┐
│ 2️⃣  AssemblyAI（国际备用，可选）    │
│    - 121-420分钟免费                │
│    - 需要VPN                        │
└─────────────────────────────────────┘
            ↓ 不可用/超额
┌─────────────────────────────────────┐
│ 3️⃣  Whisper（保底方案）             │
│    - 付费 $0.006/分钟               │
│    - 可能需要代理                   │
└─────────────────────────────────────┘
```

### 🤖 智能分析服务选择

```
┌─────────────────────────────────────┐
│ 1️⃣  通义千问（国内推荐）✨           │
│    - 100万 tokens/月 免费          │
│    - 无需VPN                        │
│    - 完全兼容 OpenAI                │
│    - 成本：超出后 ¥0.008/1K tokens │
└─────────────────────────────────────┘
            ↓ 不可用
┌─────────────────────────────────────┐
│ 2️⃣  OpenAI GPT-4（国际备用）        │
│    - 成本：$30/1M tokens           │
│    - 需要代理                       │
└─────────────────────────────────────┘
```

## 💰 成本对比

### 场景：每天 10 个视频 × 5 分钟 = 1500 分钟/月

#### 语音转文字成本

| 方案 | 月成本 | 年成本 | 节省 |
|------|--------|--------|------|
| **仅 Whisper** | $9.00 | $108.00 | - |
| **阿里云 + Whisper** | $8.28 | $99.36 | $8.64/年 |
| **阿里云 + AssemblyAI + Whisper** | **$6.48** | **$77.76** | **$30.24/年** ✨ |

#### 智能分析成本（假设每个视频生成 2000 tokens）

| 方案 | 月成本（1500视频） | 年成本 | 优势 |
|------|------------------|--------|------|
| **通义千问** | ¥0 | ¥0 | 免费额度足够（100万 tokens/月） |
| **OpenAI GPT-4** | $90 | $1,080 | 需要代理，成本高 |

#### 💡 最优组合（国内用户）

```
阿里云语音 + 通义千问
  语音转文字: $6.48/年
  智能分析:   ¥0/年（免费额度内）
  
总成本: 约 $6.48/年 vs 纯 OpenAI 方案 $1,188/年
节省: 99.5% 💰
```

## 🎓 使用示例

### 场景 1: 轻度使用（每月 50 分钟）

```bash
# 配置：仅阿里云 + OpenAI
ALIYUN_ACCESS_KEY_ID=...
ALIYUN_ACCESS_KEY_SECRET=...
ALIYUN_NLS_APP_KEY=...
OPENAI_API_KEY=...

# 成本：完全免费！（阿里云免费额度）
```

### 场景 2: 中度使用（每月 500 分钟）

```bash
# 推荐配置：阿里云 + AssemblyAI + OpenAI
ALIYUN_ACCESS_KEY_ID=...
ALIYUN_ACCESS_KEY_SECRET=...
ALIYUN_NLS_APP_KEY=...
ASSEMBLYAI_API_KEY=...  # 需要VPN，可选
OPENAI_API_KEY=...

# 成本明细：
# - 前120分钟: 免费（阿里云）
# - 121-420分钟: 免费（AssemblyAI，如果配置）
# - 421-500分钟: 80分钟 × $0.006 = $0.48/月
# 总计: $0.48/月
```

### 场景 3: 重度使用（每月 1500 分钟）

```bash
# 推荐配置：阿里云 + AssemblyAI + OpenAI
# 同上

# 成本明细：
# - 前120分钟: 免费（阿里云）
# - 121-420分钟: 免费（AssemblyAI）
# - 421-1500分钟: 1080分钟 × $0.006 = $6.48/月
# 总计: $6.48/月
```

## 🛠️ 常见问题

### Q1: 提示"阿里云语音服务未配置"

**解决方案：**
```bash
# 检查 .env 文件
cat .env | grep ALIYUN

# 确保三个变量都配置了
ALIYUN_ACCESS_KEY_ID=xxx
ALIYUN_ACCESS_KEY_SECRET=xxx
ALIYUN_NLS_APP_KEY=xxx

# 重启服务
npm run dev:all
```

### Q2: 转录失败，提示"签名错误"

**解决方案：**
```bash
# 1. 确认 AccessKey 正确
# 登录阿里云控制台重新检查

# 2. 同步系统时间
sudo ntpdate time.apple.com  # macOS
sudo ntpdate ntp.ubuntu.com  # Linux
```

### Q3: 免费额度用完了怎么办？

**答案：** 系统会自动降级到下一个服务。

您有三个选择：

1. **等待重置**（每月1号 00:00）
2. **使用其他服务**（AssemblyAI 或 Whisper）
3. **充值阿里云账户**（超额后 ¥0.25/分钟）

### Q4: 可以只用阿里云，不用 OpenAI 吗？

**答案：** 不可以。

- 阿里云：仅用于**语音转文字**
- OpenAI：用于 **GPT-4 分析**学习报告（必需）

### Q5: AssemblyAI 还需要配置吗？

**答案：** 可选。

- ✅ **有VPN**：推荐配置（每月额外300分钟免费）
- ❌ **无VPN**：无需配置（阿里云够用）

## 📚 延伸阅读

### 配置文档
- 📖 [阿里云详细配置指南](./docs/getting-started/ALIYUN_QUICKSTART.md)
- 🔧 [阿里云集成技术文档](./docs/technical/ALIYUN_INTEGRATION.md)
- 📊 [所有转录服务对比](./docs/technical/TRANSCRIPTION_SERVICES_COMPARISON.md)

### 故障排查
- 🛠️ [完整故障排除指南](./docs/guides/TROUBLESHOOTING.md)
- 🆘 [紧急问题解决](./IMMEDIATE_HELP.md)

### 其他文档
- 📝 [迁移指南](./ALIYUN_MIGRATION_GUIDE.md)
- 💡 [使用指南](./docs/guides/USAGE_GUIDE.md)

## 🎁 额外福利

### 其他国内替代方案

如果不想使用阿里云，还有其他选择：

| 服务 | 免费额度 | 价格 | 获取链接 |
|------|---------|------|---------|
| **腾讯云** | 10小时/月 | ¥0.24/分钟 | [申请](https://cloud.tencent.com/product/asr) |
| **讯飞** | 500次/天 | ¥0.2/分钟 | [申请](https://www.xfyun.cn/) |
| **百度云** | 50小时/月 | ¥0.40/分钟 | [申请](https://cloud.baidu.com/product/speech) |

⚠️ **注意：** 这些服务需要额外开发集成代码，目前项目仅支持阿里云。

## 💡 小贴士

### 1. 节省免费额度

```bash
# 开发测试时使用模拟数据
USE_MOCK_ANALYSIS=true

# 正式使用时才开启真实分析
USE_MOCK_ANALYSIS=false
```

### 2. 监控使用量

```bash
# 查询剩余额度
curl http://localhost:3001/api/analysis/quota

# 响应示例：
# {
#   "aliyun": {
#     "remainingMinutes": 95,
#     "usagePercentage": 21
#   }
# }
```

### 3. 批量处理建议

如果需要批量分析视频：

1. 前120分钟用阿里云（免费）
2. 额度用完后切换到模拟数据测试
3. 等待下月1号额度重置

## 🆘 需要帮助？

### 技术支持

1. 📖 查看[故障排查文档](./docs/guides/TROUBLESHOOTING.md)
2. 🧪 运行测试脚本：`node test-aliyun.js`
3. 🔍 检查后端日志：`npm run dev:server`
4. 💬 提交 Issue（附上日志和错误信息）

### 阿里云客服

- 💬 在线客服：[https://www.aliyun.com/service](https://www.aliyun.com/service)
- 📞 客服电话：95187
- 📧 工单系统：控制台右上角"工单"

---

## 🎉 总结

通过配置阿里云语音服务，您可以：

✅ **无需VPN**使用视频分析功能  
✅ **每月节省**高达 $2.52（三层配置）  
✅ **享受快速**稳定的转录服务  
✅ **自动降级**保障，无需担心中断  

**立即开始：**

```bash
# 1. 查看详细配置指南
open docs/getting-started/ALIYUN_QUICKSTART.md

# 2. 配置环境变量
nano .env

# 3. 测试配置
node test-aliyun.js

# 4. 启动服务
npm run dev:all
```

祝使用愉快！🎉

---

**更新日期：** 2025-11-07  
**版本：** 1.0.0

